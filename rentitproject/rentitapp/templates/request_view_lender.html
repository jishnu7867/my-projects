{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Rental Requests - LensRent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
      .card-hover:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.08); transition: .3s; }
      .request-status { font-size: 0.85rem; text-transform: capitalize; }
      .renter-avatar { width:48px; height:48px; object-fit:cover; border-radius:50%; }
      .product-thumb { width:70px; height:70px; border-radius:10px; object-fit:cover; }
      .sidebar { background: #fff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
      .details-card { background: #fff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); padding: 20px; }
    </style>
  </head>

  <body class="bg-light">

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
      <div class="container">
        <a class="navbar-brand" href="/index/">Cam<span>Rent</span></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a href="/dashboard_lender/" class="nav-link">Dashboard</a></li>
            <li class="nav-item"><a href="/my_listings/" class="nav-link">My Listings</a></li>
            <li class="nav-item"><a href="/request_view_lender/" class="nav-link active">Requests</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Header -->
    <section class="py-4 border-bottom bg-white">
      <div class="container">
        <h3 class="mb-0">Rental Requests</h3>
        <p class="text-muted small mb-0">View and manage rental requests for your listed items.</p>
      </div>
    </section>

    <!-- Main Content -->
    <main class="py-4">
      <div class="container">
        <div class="row g-4">

          <!-- Left Column: Requests list -->
          <div class="col-lg-5">
            <div class="sidebar p-3">
              <h6 class="mb-3">All Requests</h6>
              {% if requests %}
                <div class="list-group">
                  {% for req in requests %}
                    <a href="/request_view_lender/{{ req.id }}/" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if selected_request and selected_request.id == req.id %}active{% endif %}">
                      <div>
                        <div><strong>{{ req.renter.fname }} {{ req.renter.lname }}</strong></div>
                        <small class="text-muted">Requested {{ req.rental_days }} day(s) â€” {{ req.product.title|truncatechars:25 }}</small>
                      </div>
                      <span class="badge bg-{% if req.status == 'pending' %}warning{% elif req.status == 'accepted' %}success{% else %}secondary{% endif %}">
                        {{ req.status }}
                      </span>
                    </a>
                  {% endfor %}
                </div>
              {% else %}
                <p class="text-muted">No rental requests yet.</p>
              {% endif %}
            </div>
          </div>

          <!-- Right Column: Selected Request Details -->
          <div class="col-lg-7">
            {% if selected_request %}
              <div class="details-card">
                <div class="d-flex align-items-center justify-content-between mb-3">
                  <h5 class="mb-0">Request Details</h5>
                  <span class="badge bg-{% if selected_request.status == 'pending' %}warning{% elif selected_request.status == 'accepted' %}success{% else %}secondary{% endif %}">
                    {{ selected_request.status }}
                  </span>
                </div>

                <div class="d-flex align-items-center mb-3">
                  <img src="{{ selected_request.renter.p_image.url|default:'/static/images/avatar.png' }}" alt="renter" class="renter-avatar me-3">
                  <div>
                    <strong>{{ selected_request.renter.fname }} {{ selected_request.renter.lname }}</strong><br>
                    <small class="text-muted">{{ selected_request.renter.email }}</small><br>
                    <small class="text-muted">ðŸ“ž {{ selected_request.renter.phone }}</small>
                  </div>
                </div>

                <hr>

                <div class="d-flex align-items-center mb-3">
                  {% if selected_request.product.image %}
                    <img src="{{ selected_request.product.image.url }}" alt="{{ selected_request.product.title }}" class="product-thumb me-3">
                  {% endif %}
                  <div>
                    <h6 class="mb-1">{{ selected_request.product.title }}</h6>
                    <small class="text-muted">{{ selected_request.product.brand }}</small><br>
                    <small class="text-muted">â‚¹{{ selected_request.product.daily_price }} / day</small>
                  </div>
                </div>

                <p class="mb-2"><strong>Rental Duration:</strong> {{ selected_request.rental_days }} day(s)</p>
                <p class="mb-2"><strong>Total Estimated Cost:</strong> â‚¹{{ selected_request.product.daily_price|floatformat:0|add:"0"|floatformat:0|add:"0" }} Ã— {{ selected_request.rental_days }} = â‚¹{{ selected_request.product.daily_price|floatformat:0|floatformat:0|add:"0"|floatformat:0 }}</p>

                <p><strong>Requested on:</strong> {{ selected_request.created_at|date:"M d, Y H:i" }}</p>

                {% if selected_request.status == 'pending' %}
                  <div class="mt-3 d-flex gap-2">
                    <a href="/approve_request/{{ selected_request.id }}/" class="btn btn-success">Approve</a>
                    <a href="/reject_request/{{ selected_request.id }}/" class="btn btn-outline-danger">Reject</a>
                  </div>
                {% elif selected_request.status == 'accepted' %}
                  <div class="alert alert-success mt-3 mb-0">Request already approved.</div>
                {% elif selected_request.status == 'rejected' %}
                  <div class="alert alert-secondary mt-3 mb-0">Request was rejected.</div>
                {% endif %}
              </div>
                {% if selected_request.status == 'accepted' %}
                    <div><a href="/payment/{{ selected_request.id }}/" class="btn btn-success">Proceed To Payment</a></div>
                {% endif %}
                
            {% else %}
              <div class="details-card text-center py-5 text-muted">
                <p>Select a request on the left to view details.</p>
              </div>
            {% endif %}
            <div>
              <a href="/dashboard_both/" class="btn btn-secondary btn-lg">Back</a>
            </div>
          </div>

        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-top py-3 mt-5">
      <div class="container text-center small text-muted">
        &copy; {{ now.year }} LensRent â€” Manage your rentals securely.
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
